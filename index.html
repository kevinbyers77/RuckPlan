<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rucking Plan (Multi-Plan)</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{--bg:#0b1220;--card:#122033;--muted:#7c8aa0;--text:#eaf2ff;--accent:#4aa3ff;--good:#90e39a;--warn:#ffd166;--radius:16px}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:#0e1a2a;border-bottom:1px solid rgba(255,255,255,.08)}
    .wrap{max-width:980px;margin:0 auto;padding:12px 16px}
    h1{margin:4px 0 8px;font-size:1.5rem}
    .totals{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .pill{background:#122033;border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:8px 14px;display:flex;gap:8px;align-items:baseline}
    .pill .big{font-weight:800}
    .pill.good .big{color:var(--good)} .pill.warn .big{color:var(--warn)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .controls .btn, .btn{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.2);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .controls .btn:hover,.btn:hover{border-color:var(--accent)}
    .settings{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}
    .setting{display:flex;flex-direction:column;gap:6px}
    .setting input[type=number]{width:100%;padding:8px 10px;border-radius:10px;background:#0e1a2a;border:1px solid rgba(255,255,255,.1);color:var(--text)}
    .radio{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    main{max-width:980px;margin:10px auto 80px;padding:0 16px;display:grid;gap:10px}
    .week{background:#122033;border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden}
    .weekHead{display:grid;grid-template-columns:1fr auto;gap:8px;padding:12px;border-bottom:1px solid rgba(255,255,255,.06)}
    .facts{display:flex;gap:8px;flex-wrap:wrap}
    .fact{border:1px dashed rgba(255,255,255,.15);border-radius:999px;padding:6px 10px;font-size:.9rem}
    .desc{color:var(--muted);font-size:.92rem}
    .sessions{padding:8px 12px}
    .session{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:8px;padding:8px 6px}
    .session:not(:last-child){border-bottom:1px dashed rgba(255,255,255,.07)}
    .session.done{opacity:.5;filter:saturate(.4)}
    .distInput{display:flex;gap:6px;align-items:center}
    footer{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg, rgba(11,18,32,.05), rgba(11,18,32,.9))}
    .footerWrap{max-width:980px;margin:0 auto;padding:10px 16px;display:flex;justify-content:space-between;color:var(--muted)}
    /* Chooser overlay (mobile-friendly) */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
    .modal{position:relative;background:#0e1a2a;border:1px solid rgba(255,255,255,.1);border-radius:16px;max-width:900px;width:100%;padding:16px;max-height:85vh;overflow:auto;padding-bottom:calc(16px + env(safe-area-inset-bottom))}
    .topbar{position:sticky; top:0; background:linear-gradient(180deg, rgba(14,26,42,1), rgba(14,26,42,.8)); padding:6px 0; display:flex; justify-content:space-between; align-items:center; gap:8px; z-index:1}
    .closeX{border:none;background:transparent;color:var(--text);font-size:1.3rem;line-height:1;cursor:pointer;padding:6px 10px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:8px}
    .card{background:#122033;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px;transition:border-color .2s, box-shadow .2s}
    .card.selected{border-color:var(--accent); box-shadow:0 0 0 2px rgba(74,163,255,.35) inset}
    .badge{border:1px solid rgba(255,255,255,.2); border-radius:999px; padding:2px 8px; font-size:.8rem; color:var(--muted)}
    @media(max-width:680px){.totals{grid-template-columns:1fr}.settings{grid-template-columns:1fr}.weekHead{grid-template-columns:1fr}.grid{grid-template-columns:1fr}}
    body.hasOverlay footer{display:none}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Rucking Plan <small id="presetName" style="font-size:.9rem;color:var(--muted)"></small></h1>
    <div class="totals">
      <div class="pill good"><span class="big" id="doneCount">0/0</span> <small>sessions</small></div>
      <div class="pill warn"><span class="big" id="totalDist">0.0</span> <small id="totalDistLabel">km completed</small></div>
      <div class="pill"><span class="big" id="totalCals">â€”</span> <small>kcal (set body weight)</small></div>
    </div>
    <div class="controls">
      <button id="changePlan" class="btn">Change plan</button>
      <button id="ideaBfast" class="btn">ðŸŽ² Breakfast idea</button>
      <button id="ideaMeal" class="btn">ðŸŽ² Lunch/Dinner idea</button>

      <details>
        <summary><strong>Settings</strong></summary>
        <div class="settings">
          <!-- Meal ideas (custom) -->
          <div class="setting">
            <label>Custom breakfast ideas (one per line)</label>
            <textarea id="customBreakfasts" rows="4" style="width:100%;padding:8px;border-radius:10px;background:#0e1a2a;border:1px solid rgba(255,255,255,.1);color:var(--text)"></textarea>
          </div>
          <div class="setting">
            <label>Custom lunch/dinner ideas (one per line)</label>
            <textarea id="customMeals" rows="6" style="width:100%;padding:8px;border-radius:10px;background:#0e1a2a;border:1px solid rgba(255,255,255,.1);color:var(--text)"></textarea>
            <small class="desc">Leave blank to use the default list. Your lists are saved on this device.</small>
          </div>

          <!-- Existing settings -->
          <div class="setting">
            <label>Body weight</label>
            <div class="radio">
              <input type="number" id="bodyWeight" placeholder="e.g., 80" min="0" step="0.1"/>
              <label><input type="radio" name="bwUnit" value="kg" checked> kg</label>
              <label><input type="radio" name="bwUnit" value="lbs"> lbs</label>
            </div>
          </div>
          <div class="setting">
            <label>Distance units</label>
            <div class="radio">
              <label><input type="radio" name="distUnit" value="mi"> miles</label>
              <label><input type="radio" name="distUnit" value="km" checked> km</label>
            </div>
          </div>
          <div class="setting">
            <label>Load units</label>
            <div class="radio">
              <label><input type="radio" name="wtUnit" value="lbs" checked> lbs</label>
              <label><input type="radio" name="wtUnit" value="kg"> kg</label>
            </div>
          </div>
          <div class="setting">
            <label>Calorie model</label>
            <div class="radio">
              <input type="number" id="kcalPerKgKm" value="1.0" min="0.5" max="1.5" step="0.05"/>
              <small>kcal â‰ˆ (body + pack) Ã— km Ã— factor</small>
            </div>
          </div>
          <div class="setting">
            <button id="resetBtn" class="btn" type="button">Reset progress</button>
          </div>
        </div>
      </details>
    </div>
  </div>
</header>

<main id="app"></main>

<footer>
  <div class="footerWrap">
    <span id="plannedTotals">Planned total: â€”</span>
    <span>Data stays on this device.</span>
  </div>
</footer>

<!-- Plan chooser -->
<div id="chooser" class="overlay">
  <div class="modal">
    <div class="topbar">
      <h2 style="margin:0 8px 0 8px">Choose a plan</h2>
      <button id="xClose" class="closeX" aria-label="Close">âœ•</button>
    </div>
    <div class="grid" id="planGrid"></div>
  </div>
</div>

<!-- Idea modal (moved ABOVE the script so JS can bind) -->
<div id="ideaModal" class="overlay" style="display:none">
  <div class="modal">
    <div class="topbar">
      <h2 style="margin:0 8px">Meal idea</h2>
      <button id="ideaClose" class="closeX" aria-label="Close">âœ•</button>
    </div>
    <div style="padding:8px 8px 0">
      <p id="ideaText" style="font-size:1.1rem;margin:8px 0 12px"></p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="ideaAnother" class="btn">Another</button>
        <button id="ideaCopy" class="btn">Copy</button>
      </div>
    </div>
  </div>
</div>

<script>
// Register SW if present (optional)
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }

// Helpers
const mi2km = mi => mi*1.60934, km2mi = km => km/1.60934, lbs2kg = lbs => lbs*0.45359237, round1=n=>Math.round(n*10)/10;
function makeLinear(start,end,n){const a=[];for(let i=0;i<n;i++){const t=i/(n-1);a.push(start+(end-start)*t);}return a;}

// Presets
const PRESETS=[
  { id:'easy', name:'Easy', desc:'Gentle ramp; lighter pack', freq:3,
    build(){ const dmins=makeLinear(1.5,3.5,12), dmaxs=makeLinear(2.5,4.5,12), w=makeLinear(10,20,12);
      return dmins.map((dmin,i)=>({title:i===0?'Foundation week â€“ establish routine':i===11?'Peak week â€“ celebrate!':(i%2? 'Weight progression week' : 'Distance progression week'), dmin:round1(dmin), dmax:round1(dmaxs[i]), wlbs:Math.round(w[i])})); } },
  { id:'medium', name:'Medium (original)', desc:'Balanced ramp; 12 weeks', freq:3,
    build(){ return [
      {title:'Foundation week â€“ focus on form, pacing, and establishing routine', dmin:2,dmax:3,wlbs:15},
      {title:'Weight progression week â€“ building strength capacity', dmin:2,dmax:3,wlbs:18},
      {title:'Distance progression week â€“ building endurance capacity', dmin:3,dmax:4,wlbs:18},
      {title:'Weight progression week â€“ building strength capacity Â· End of foundation phase â€“ assess comfort and form', dmin:3,dmax:4,wlbs:20},
      {title:'Distance progression week â€“ building endurance capacity', dmin:3,dmax:4,wlbs:20},
      {title:'Weight progression week â€“ building strength capacity', dmin:3,dmax:4,wlbs:23},
      {title:'Distance progression week â€“ building endurance capacity', dmin:4,dmax:5,wlbs:23},
      {title:'Weight progression week â€“ building strength capacity Â· Mid-program checkpoint â€“ evaluate progress and adjust as needed', dmin:4,dmax:5,wlbs:25},
      {title:'Distance progression week â€“ building endurance capacity', dmin:5,dmax:6,wlbs:25},
      {title:'Weight progression week â€“ building strength capacity', dmin:5,dmax:6,wlbs:28},
      {title:'Distance progression week â€“ building endurance capacity', dmin:5,dmax:6,wlbs:28},
      {title:'Peak week â€“ celebrate your achievement and plan your next challenge!', dmin:5,dmax:6,wlbs:30},
    ]; } },
  { id:'hard', name:'Hard', desc:'Aggressive ramp; heavier pack', freq:3,
    build(){ const dmins=makeLinear(3,5.5,12), dmaxs=makeLinear(4,7,12), w=makeLinear(20,35,12);
      return dmins.map((dmin,i)=>({title:i%2? 'Distance progression week' : 'Weight progression week', dmin:round1(dmin), dmax:round1(dmaxs[i]), wlbs:Math.round(w[i])})); } },
  { id:'weightloss', name:'Focus: Weight loss', desc:'More frequency; moderate weight; steady distances', freq:4,
    build(){ const d=makeLinear(3,5,12), w=makeLinear(10,18,12);
      return d.map((dm,i)=>({title:'Fat-burn block â€“ brisk pace, low pack', dmin:round1(dm-0.5), dmax:round1(dm+0.5), wlbs:Math.round(w[i])})); } },
  { id:'distance', name:'Focus: Distance', desc:'Longer distances; moderate weight', freq:3,
    build(){ const dmins=makeLinear(3.5,6.5,12), dmaxs=makeLinear(4.5,8,12); const w=Array(12).fill(20);
      return dmins.map((dmin,i)=>({title:'Endurance block â€“ extend time on feet', dmin:round1(dmin), dmax:round1(dmaxs[i]), wlbs:w[i]})); } },
];

// State
const STORAGE_KEY='ruck-multipreset-v2';
let state = Object.assign({ sessions:{}, presetId:null, weeks:[], freq:3, distUnit:'km', wtUnit:'lbs', bwUnit:'kg', bodyWeight:'', kcalPerKgKm:1.0 }, load());
function load(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||{}}catch{return{}} }
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

// DOM refs
const app=document.getElementById('app'), chooser=document.getElementById('chooser'), planGrid=document.getElementById('planGrid'), presetNameEl=document.getElementById('presetName');

// Open/close
document.getElementById('changePlan').onclick=()=> openChooser(false);
document.getElementById('xClose').onclick=()=> closeChooser();

function openChooser(first){
  chooser.style.display='flex'; document.body.classList.add('hasOverlay'); planGrid.innerHTML='';
  PRESETS.forEach(p=>{
    const selected = (state.presetId===p.id);
    const card=document.createElement('div'); card.className='card'+(selected?' selected':''); 
    card.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0">${p.name}</h3>${selected?'<span class="badge">Selected</span>':''}</div>
                    <div class='desc'>${p.desc}</div><div class='facts'><span class='fact'>${p.freq}Ã— / week</span><span class='fact'>12 weeks</span></div>
                    <div><button class='btn'>${selected?'Choose again':'Choose'}</button></div>`;
    card.querySelector('button').onclick=()=>{
      if(state.presetId && !first && state.presetId!==p.id && !confirm('Switching plan will reset your progress. Continue?')) return;
      applyPreset(p); closeChooser();
    };
    planGrid.appendChild(card);
  });
}
function closeChooser(){ chooser.style.display='none'; document.body.classList.remove('hasOverlay'); }

function applyPreset(p){ state.presetId=p.id; state.freq=p.freq; state.weeks=p.build(); state.sessions={}; save(); render(); }
function currentPreset(){ return PRESETS.find(p=>p.id===state.presetId); }

// Rendering helpers
const defaultMid = w => (w.dmin+w.dmax)/2;
const convertMilesToUnit = mi => state.distUnit==='mi'? round1(mi) : round1(mi2km(mi));
const convertUnitToMiles = v  => state.distUnit==='mi'? v : km2mi(v);
function ensure(key){ if(!state.sessions[key]) state.sessions[key]={done:false, distMi:null}; }
function defaultDistFor(key, week){ return (state.sessions[key]?.distMi != null) ? state.sessions[key].distMi : defaultMid(week); }
function currentBodyKg(){ const bw=parseFloat(document.getElementById('bodyWeight').value||state.bodyWeight); if(!isFinite(bw)||bw<=0) return null; return ((document.querySelector('input[name="bwUnit"]:checked')?.value)||state.bwUnit)==='kg'?bw:lbs2kg(bw); }

function render(){
  if(!state.presetId){ openChooser(true); }
  const weeks = state.weeks || []; const FREQ = state.freq || 3;
  presetNameEl.textContent = currentPreset()?`Â· ${currentPreset().name}`:'';

  app.innerHTML='';
  weeks.forEach((week, idx)=>{
    const card=document.createElement('section'); card.className='week';
    const head=document.createElement('div'); head.className='weekHead';
    head.innerHTML = `<div><h2 style='margin:0'>Week ${idx+1}</h2><div class='desc'>${week.title}</div></div>`;
    const facts=document.createElement('div'); facts.className='facts';
    const [d1,d2] = state.distUnit==='mi'? [week.dmin,week.dmax] : [round1(mi2km(week.dmin)), round1(mi2km(week.dmax))];
    facts.innerHTML = `<div class='fact'>Distance: ${d1}â€“${d2} ${state.distUnit}</div><div class='fact'>Weight: ${(state.wtUnit==='lbs'?week.wlbs:Math.round(lbs2kg(week.wlbs)))} ${state.wtUnit}</div><div class='fact'>Frequency: ${FREQ}Ã—</div>`;
    head.appendChild(facts);

    const ses=document.createElement('div'); ses.className='sessions';
    for(let i=1;i<=FREQ;i++){
      const key=`w${idx+1}d${i}`;
      const row=document.createElement('div'); row.className='session'; if(state.sessions[key]?.done) row.classList.add('done');
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!state.sessions[key]?.done; cb.onchange=()=>{ ensure(key); state.sessions[key].done=cb.checked; row.classList.toggle('done',cb.checked); saveUpdate(); };
      const lbl=document.createElement('span'); lbl.innerHTML=`<strong>Session ${i}</strong> <small class='desc'>Pack ${(state.wtUnit==='lbs'?week.wlbs:Math.round(lbs2kg(week.wlbs)))} ${state.wtUnit}</small>`;
      const distBox=document.createElement('div'); distBox.className='distInput';
      const input=document.createElement('input'); input.type='number'; input.step='0.1'; input.min='0'; input.value = convertMilesToUnit(defaultDistFor(key, week));
      const unit=document.createElement('small'); unit.textContent=state.distUnit;
      input.oninput=()=>{ ensure(key); const v=parseFloat(input.value); state.sessions[key].distMi = isFinite(v)?convertUnitToMiles(v):null; saveUpdate(); };
      distBox.append(input, unit);
      row.append(cb,lbl,distBox);
      ses.appendChild(row);
    }

    card.append(head, ses);
    app.appendChild(card);
  });

  updateTotals(); updatePlanned(); wireSettings();
}

function updateTotals(){
  const weeks = state.weeks || []; const FREQ = state.freq || 3;
  let completed=0, distMi=0, kcal=0, have=false;
  weeks.forEach((w, wi)=>{
    for(let i=1;i<=FREQ;i++){ const key=`w${wi+1}d${i}`; const s=state.sessions[key]; if(s?.done){ completed++; const dmi=defaultDistFor(key,w); distMi+=dmi; const kg=currentBodyKg(); if(kg){ const k=(kg+lbs2kg(w.wlbs))*mi2km(dmi)*(parseFloat(document.getElementById('kcalPerKgKm').value||state.kcalPerKgKm)||1.0); kcal+=k; have=true; } } }
  });
  document.getElementById('doneCount').textContent = `${completed}/${FREQ * (weeks.length||12)}`;
  const du=state.distUnit; const dOut=du==='mi'?distMi:mi2km(distMi);
  document.getElementById('totalDist').textContent = round1(dOut).toFixed(1);
  document.getElementById('totalDistLabel').textContent = `${du} completed`;
  document.getElementById('totalCals').textContent = have? Math.round(kcal) : 'â€”';
}

function updatePlanned(){
  const weeks = state.weeks || []; const FREQ = state.freq || 3; const kg=currentBodyKg();
  const factor=parseFloat(document.getElementById('kcalPerKgKm').value||state.kcalPerKgKm)||1.0;
  let totalMi=0, totalKcal=0; weeks.forEach(w=>{ const per=defaultMid(w); totalMi+=per*FREQ; if(kg){ totalKcal += (kg + lbs2kg(w.wlbs))*mi2km(per)*factor*FREQ; } });
  const distOut = state.distUnit==='mi'? `${round1(totalMi)} mi` : `${round1(mi2km(totalMi))} km`;
  document.getElementById('plannedTotals').textContent = `Planned distance â‰ˆ ${distOut}` + (kg?` Â· Planned kcal â‰ˆ ${Math.round(totalKcal)}`:'');
}

function wireSettings(){
  const bw=document.getElementById('bodyWeight'); if(state.bodyWeight!=='') bw.value=state.bodyWeight; bw.oninput=()=>{ state.bodyWeight=bw.value; save(); updatePlanned(); updateTotals(); };
  for(const r of document.querySelectorAll('input[name="bwUnit"]')){ r.checked=(r.value===state.bwUnit); r.onchange=()=>{ state.bwUnit=r.value; save(); updatePlanned(); updateTotals(); }; }
  for(const r of document.querySelectorAll('input[name="distUnit"]')){ r.checked=(r.value===state.distUnit); r.onchange=()=>{ state.distUnit=r.value; save(); render(); }; }
  for(const r of document.querySelectorAll('input[name="wtUnit"]')){ r.checked=(r.value===state.wtUnit); r.onchange=()=>{ state.wtUnit=r.value; save(); render(); }; }
  const factor=document.getElementById('kcalPerKgKm'); factor.value=state.kcalPerKgKm; factor.oninput=()=>{ state.kcalPerKgKm=parseFloat(factor.value)||1.0; save(); updatePlanned(); updateTotals(); };
  document.getElementById('resetBtn').onclick=()=>{ if(confirm('Reset all progress?')){ state.sessions={}; save(); render(); } };
  wireMealIdeaSettings();
}

// Save helper
function saveUpdate(){ save(); updateTotals(); }

// Default meal lists (your picks)
const DEFAULT_BREAKFASTS = [
  "Oatmeal + fruit",
  "Eggs & potato hash + fruit",
  "Peanut butter toast + fruit",
  "Omelet + fruit"
];

const DEFAULT_MEALS = [
  "Peanut butter sandwich",
  "Chicken wrap with spinach & carrot",
  "Faux burger",
  "Chicken & rice bowl",
  "Tuna & crackers"
];

function getCustomList(key) {
  const raw = (localStorage.getItem(key) || "").trim();
  if (!raw) return null;
  const lines = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  return lines.length ? lines : null;
}
function mergedList(defaults, key) {
  const custom = getCustomList(key);
  return (custom && custom.length) ? custom : defaults;
}
function pick(list) { return list[Math.floor(Math.random() * list.length)]; }

// Idea modal wiring
const ideaModal = document.getElementById("ideaModal");
const ideaText  = document.getElementById("ideaText");

function openIdea(kind) {
  const breakfasts = mergedList(DEFAULT_BREAKFASTS, "meal-custom-breakfasts");
  const meals      = mergedList(DEFAULT_MEALS, "meal-custom-meals");
  const pool = (kind === "breakfast") ? breakfasts : meals;
  ideaText.textContent = pick(pool);
  ideaModal.style.display = "flex";
  document.body.classList.add("hasOverlay");
  ideaModal.dataset.kind = kind;
}
function closeIdea() {
  ideaModal.style.display = "none";
  document.body.classList.remove("hasOverlay");
}
document.getElementById("ideaBfast").addEventListener("click", () => openIdea("breakfast"));
document.getElementById("ideaMeal").addEventListener("click",  () => openIdea("meal"));
document.getElementById("ideaClose").addEventListener("click", closeIdea);
ideaModal.addEventListener("click", (e) => { if (e.target === ideaModal) closeIdea(); });
document.getElementById("ideaAnother").addEventListener("click", () => {
  const kind = ideaModal.dataset.kind || "meal";
  openIdea(kind);
});
document.getElementById("ideaCopy").addEventListener("click", async () => {
  try { await navigator.clipboard.writeText(ideaText.textContent); } catch {}
});

// Save/load custom lists
function wireMealIdeaSettings() {
  const bEl = document.getElementById("customBreakfasts");
  const mEl = document.getElementById("customMeals");
  bEl.value = localStorage.getItem("meal-custom-breakfasts") || "";
  mEl.value = localStorage.getItem("meal-custom-meals") || "";
  const saveLists = () => {
    localStorage.setItem("meal-custom-breakfasts", bEl.value.trim());
    localStorage.setItem("meal-custom-meals", mEl.value.trim());
  };
  bEl.addEventListener("input", saveLists);
  mEl.addEventListener("input", saveLists);
}

// Boot
render();
</script>
</body>
</html>
