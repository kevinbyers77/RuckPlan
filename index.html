<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rucking Plan (Multi‑Plan)</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{--bg:#0b1220;--card:#122033;--muted:#7c8aa0;--text:#eaf2ff;--accent:#4aa3ff;--good:#90e39a;--warn:#ffd166;--radius:16px}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:#0e1a2a;border-bottom:1px solid rgba(255,255,255,.08)}
    .wrap{max-width:980px;margin:0 auto;padding:12px 16px}
    h1{margin:4px 0 8px;font-size:1.5rem}
    .totals{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .pill{background:#122033;border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:8px 14px;display:flex;gap:8px;align-items:baseline}
    .pill .big{font-weight:800}
    .pill.good .big{color:var(--good)} .pill.warn .big{color:var(--warn)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .controls details{background:#122033;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:6px 10px}
    .settings{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}
    .setting{display:flex;flex-direction:column;gap:6px}
    .setting input[type=number], .setting input[type=time], .setting select{width:100%;padding:8px 10px;border-radius:10px;background:#0e1a2a;border:1px solid rgba(255,255,255,.1);color:var(--text)}
    .radio{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    main{max-width:980px;margin:10px auto 80px;padding:0 16px;display:grid;gap:10px}
    .week{background:#122033;border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden}
    .weekHead{display:grid;grid-template-columns:1fr auto;gap:8px;padding:12px;border-bottom:1px solid rgba(255,255,255,.06)}
    .facts{display:flex;gap:8px;flex-wrap:wrap}
    .fact{border:1px dashed rgba(255,255,255,.15);border-radius:999px;padding:6px 10px;font-size:.9rem}
    .desc{color:var(--muted);font-size:.92rem}
    .sessions{padding:8px 12px}
    .session{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:8px;padding:8px 6px}
    .session:not(:last-child){border-bottom:1px dashed rgba(255,255,255,.07)}
    .session.done{opacity:.5;filter:saturate(.4)}
    .distInput{display:flex;gap:6px;align-items:center}

    footer{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg, rgba(11,18,32,.05), rgba(11,18,32,.9))}
    .footerWrap{max-width:980px;margin:0 auto;padding:10px 16px;display:flex;justify-content:space-between;color:var(--muted)}

    /* Plan chooser */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
    .modal{position:relative;background:#0e1a2a;border:1px solid rgba(255,255,255,.1);border-radius:16px;max-width:900px;width:100%;padding:16px;max-height:85vh;overflow:auto;padding-bottom:calc(16px + env(safe-area-inset-bottom))}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:8px}
    .card{background:#122033;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px;transition:border-color .2s, box-shadow .2s}
    .card h3{margin:0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.2);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}.btn:hover{border-color:var(--accent)}
    .btn:hover{border-color:var(--accent)}
    @media(max-width:680px){.totals{grid-template-columns:1fr}.settings{grid-template-columns:1fr}.weekHead{grid-template-columns:1fr}.grid{grid-template-columns:1fr}} 
/* highlight and overlay tweaks */
.card.selected{border-color:var(--accent); box-shadow:0 0 0 2px rgba(74,163,255,.35) inset}
.badge{border:1px solid rgba(255,255,255,.2); border-radius:999px; padding:2px 8px; font-size:.8rem; color:var(--muted)}
.modal .topbar{position:sticky; top:0; background:linear-gradient(180deg, rgba(14,26,42,1), rgba(14,26,42,.8)); padding:6px 0; display:flex; justify-content:space-between; align-items:center; gap:8px; z-index:1}
.modal .closeX{border:none;background:transparent;color:var(--text);font-size:1.3rem;line-height:1;cursor:pointer; padding:6px 10px}
body.hasOverlay footer{display:none}.settings{grid-template-columns:1fr}.weekHead{grid-template-columns:1fr}.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Rucking Plan <small id="presetName" style="font-size:.9rem;color:var(--muted)"></small></h1>
    <div class="totals">
      <div class="pill good"><span class="big" id="doneCount">0/0</span> <small>sessions</small></div>
      <div class="pill warn"><span class="big" id="totalDist">0.0</span> <small id="totalDistLabel">mi completed</small></div>
      <div class="pill"><span class="big" id="totalCals">—</span> <small>kcal (set body weight)</small></div>
    </div>
    <div class="controls">
      <button id="changePlan" class="btn">Change plan</button>
      <details>
        <summary><strong>Settings</strong></summary>
        <div class="settings">
          <div class="setting">
            <label>Body weight</label>
            <div class="radio">
              <input type="number" id="bodyWeight" placeholder="e.g., 80" min="0" step="0.1"/>
              <label><input type="radio" name="bwUnit" value="kg" checked> kg</label>
              <label><input type="radio" name="bwUnit" value="lbs"> lbs</label>
            </div>
          </div>
          <div class="setting">
            <label>Distance units</label>
            <div class="radio">
              <label><input type="radio" name="distUnit" value="mi" checked> miles</label>
              <label><input type="radio" name="distUnit" value="km"> km</label>
            </div>
          </div>
          <div class="setting">
            <label>Load units</label>
            <div class="radio">
              <label><input type="radio" name="wtUnit" value="lbs" checked> lbs</label>
              <label><input type="radio" name="wtUnit" value="kg"> kg</label>
            </div>
          </div>
          <div class="setting">
            <label>Calorie model</label>
            <div class="radio">
              <input type="number" id="kcalPerKgKm" value="1.0" min="0.5" max="1.5" step="0.05"/>
              <small>kcal ≈ (body + pack) × km × factor</small>
            </div>
          </div>
          <div class="setting">
            <button id="resetBtn" class="btn" type="button">Reset progress</button>
          </div>
        </div>
      </details>
    </div>
  </div>
</header>
<main id="app"></main>
<footer><div class="footerWrap"><span id="plannedTotals">Planned total: —</span><span>Data stays on this device.</span></div></footer>

<div id="chooser" class="overlay">
  <div class="modal">
    <div class="topbar">
      <h2 style="margin:0 8px 0 8px">Choose a plan</h2>
      <button id="xClose" class="closeX" aria-label="Close">✕</button>
    </div>
    <div id="planGrid" class="grid"></div>
  </div>
</div>
    <div class="row" style="margin-top:8px; justify-content:flex-end"><button id="closeChooser" class="btn">Close</button></div>
  </div>
</div>

<script>
// ---------------- Presets ----------------
// Each preset returns {name, desc, weeks:[{title,dmin,dmax,wlbs}], freq}
function makeLinear(start, end, n){ const arr=[]; for(let i=0;i<n;i++){ const t=i/(n-1); arr.push(start+(end-start)*t); } return arr; }
function round1(n){ return Math.round(n*10)/10; }
const PRESETS = [
  {
    id:'easy', name:'Easy', desc:'Gentle ramp; lighter pack', freq:3,
    build(){
      const dmins=makeLinear(1.5,3.5,12), dmaxs=makeLinear(2.5,4.5,12), w=makeLinear(10,20,12);
      return dmins.map((dmin,i)=>({title:i===0?'Foundation week – establish routine':i===11?'Peak week – celebrate!':(i%2? 'Weight progression week' : 'Distance progression week'), dmin:round1(dmin), dmax:round1(dmaxs[i]), wlbs:Math.round(w[i])}));
    }
  },
  {
    id:'medium', name:'Medium (original)', desc:'Balanced ramp; 12 weeks', freq:3,
    build(){ return [
      {title:'Foundation week – focus on form, pacing, and establishing routine', dmin:2,dmax:3,wlbs:15},
      {title:'Weight progression week – building strength capacity', dmin:2,dmax:3,wlbs:18},
      {title:'Distance progression week – building endurance capacity', dmin:3,dmax:4,wlbs:18},
      {title:'Weight progression week – building strength capacity · End of foundation phase – assess comfort and form', dmin:3,dmax:4,wlbs:20},
      {title:'Distance progression week – building endurance capacity', dmin:3,dmax:4,wlbs:20},
      {title:'Weight progression week – building strength capacity', dmin:3,dmax:4,wlbs:23},
      {title:'Distance progression week – building endurance capacity', dmin:4,dmax:5,wlbs:23},
      {title:'Weight progression week – building strength capacity · Mid‑program checkpoint – evaluate progress and adjust as needed', dmin:4,dmax:5,wlbs:25},
      {title:'Distance progression week – building endurance capacity', dmin:5,dmax:6,wlbs:25},
      {title:'Weight progression week – building strength capacity', dmin:5,dmax:6,wlbs:28},
      {title:'Distance progression week – building endurance capacity', dmin:5,dmax:6,wlbs:28},
      {title:'Peak week – celebrate your achievement and plan your next challenge!', dmin:5,dmax:6,wlbs:30},
    ]; }
  },
  {
    id:'hard', name:'Hard', desc:'Aggressive ramp; heavier pack', freq:3,
    build(){
      const dmins=makeLinear(3,5.5,12), dmaxs=makeLinear(4,7,12), w=makeLinear(20,35,12);
      return dmins.map((dmin,i)=>({title:i%2? 'Distance progression week' : 'Weight progression week', dmin:round1(dmin), dmax:round1(dmaxs[i]), wlbs:Math.round(w[i])}));
    }
  },
  {
    id:'weightloss', name:'Focus: Weight loss', desc:'More frequency; moderate weight; steady distances', freq:4,
    build(){
      const d=makeLinear(3,5,12), w=makeLinear(10,18,12);
      return d.map((dm,i)=>({title:'Fat‑burn block – brisk pace, low pack', dmin:round1(dm-0.5), dmax:round1(dm+0.5), wlbs:Math.round(w[i])}));
    }
  },
  {
    id:'distance', name:'Focus: Distance', desc:'Longer distances; moderate weight', freq:3,
    build(){
      const dmins=makeLinear(3.5,6.5,12), dmaxs=makeLinear(4.5,8,12); const w=Array(12).fill(20);
      return dmins.map((dmin,i)=>({title:'Endurance block – extend time on feet', dmin:round1(dmin), dmax:round1(dmaxs[i]), wlbs:w[i]}));
    }
  }
];

// --------------- App state ---------------
const STORAGE_KEY='ruck-multipreset-v1';
const mi2km = mi => mi*1.60934, km2mi = km => km/1.60934, lbs2kg = lbs => lbs*0.45359237;
let state = Object.assign({ sessions:{}, presetId:null, freq:3, distUnit:'mi', wtUnit:'lbs', bwUnit:'kg', bodyWeight:'', kcalPerKgKm:1.0 }, load());
function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY))||{} }catch{ return {} } }
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

const app=document.getElementById('app');
const chooser=document.getElementById('chooser');
const planGrid=document.getElementById('planGrid');
const presetNameEl=document.getElementById('presetName');

document.getElementById('changePlan').onclick=()=> openChooser();
document.getElementById('closeChooser').onclick=()=> chooser.style.display='none';

function openChooser(first){
  chooser.style.display='flex';
  document.body.classList.add('hasOverlay');
  planGrid.innerHTML='';
  PRESETS.forEach(p=>{
    const selected = (state.presetId===p.id);
    const card=document.createElement('div');card.className='card'+(selected?' selected':'');
    card.innerHTML=`<div class='row' style='justify-content:space-between;align-items:center'><h3 style="margin:0">${p.name}</h3>${selected?'<span class="badge">Selected</span>':''}</div><div class='desc'>${p.desc}</div><div class='row'><span class='fact'>${p.freq}× / week</span><span class='fact'>12 weeks</span></div><div class='row'><button class='btn'>${selected?'Choose again':'Choose'}</button></div>`;
    card.querySelector('button').onclick=()=>{ if(state.presetId && !first && state.presetId!==p.id && !confirm('Switching plan will reset your progress. Continue?')) return; applyPreset(p); chooser.style.display='none'; document.body.classList.remove('hasOverlay'); };
    planGrid.appendChild(card);
  });
  document.getElementById('xClose').onclick=()=>{ chooser.style.display='none'; document.body.classList.remove('hasOverlay'); };
}</h3><div class='desc'>${p.desc}</div><div class='row'><span class='fact'>${p.freq}× / week</span><span class='fact'>12 weeks</span></div><div class='row'><button class='btn'>Choose</button></div>`;
    card.querySelector('button').onclick=()=>{ if(state.presetId && !first && !confirm('Switching plan will reset your progress. Continue?')) return; applyPreset(p); chooser.style.display='none'; };
    planGrid.appendChild(card);
  });
}

function applyPreset(p){ state.presetId=p.id; state.freq=p.freq; state.sessions={}; state.weeks=p.build(); save(); render(); }; state.weeks=p.build(); save(); render(); }

function currentPreset(){ return PRESETS.find(p=>p.id===state.presetId); }

// --------------- Rendering ---------------
function render(){
  if(!state.presetId){ openChooser(true); }
  const weeks = state.weeks || (currentPreset()?.build()||[]);
  const FREQ = state.freq || 3;
  presetNameEl.textContent = currentPreset()?`· ${currentPreset().name}`:'';

  app.innerHTML='';
  weeks.forEach((week, idx)=>{
    const card=document.createElement('section'); card.className='week';
    const head=document.createElement('div'); head.className='weekHead';
    head.innerHTML = `<div><h2 style='margin:0'>Week ${idx+1}</h2><div class='desc'>${week.title}</div></div>`;
    const facts=document.createElement('div'); facts.className='facts';
    const [d1,d2] = state.distUnit==='mi' ? [week.dmin,week.dmax] : [round1(mi2km(week.dmin)), round1(mi2km(week.dmax))];
    facts.innerHTML = `<div class='fact'>Distance: ${d1}–${d2} ${state.distUnit}</div><div class='fact'>Weight: ${(state.wtUnit==='lbs'?week.wlbs:Math.round(lbs2kg(week.wlbs)))} ${state.wtUnit}</div><div class='fact'>Frequency: ${FREQ}×</div>`;
    head.appendChild(facts);

    const ses=document.createElement('div'); ses.className='sessions';
    for(let i=1;i<=FREQ;i++){
      const key = `w${idx+1}d${i}`;
      const row=document.createElement('div'); row.className='session'; if(state.sessions[key]?.done) row.classList.add('done');
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!state.sessions[key]?.done; cb.onchange=()=>{ ensure(key); state.sessions[key].done=cb.checked; row.classList.toggle('done',cb.checked); saveUpdate(); };
      const lbl=document.createElement('span'); lbl.innerHTML = `<strong>Session ${i}</strong> <small class='desc'>Pack ${(state.wtUnit==='lbs'?week.wlbs:Math.round(lbs2kg(week.wlbs)))} ${state.wtUnit}</small>`;
      const distBox=document.createElement('div'); distBox.className='distInput';
      const input=document.createElement('input'); input.type='number'; input.step='0.1'; input.min='0'; input.value = convertMilesToUnit(defaultDistFor(key, week));
      const unit=document.createElement('small'); unit.textContent = state.distUnit;
      input.oninput=()=>{ ensure(key); const v=parseFloat(input.value); state.sessions[key].distMi = isFinite(v)?convertUnitToMiles(v):null; saveUpdate(); };
      distBox.append(input,unit);
      row.append(cb,lbl,distBox);
      ses.appendChild(row);
    }

    card.append(head, ses); app.appendChild(card);
  });

  updateTotals(); updatePlanned(); wireSettings();
}

function defaultMid(w){ return (w.dmin + w.dmax)/2; }
function defaultDistFor(key, week){ return (state.sessions[key]?.distMi != null) ? state.sessions[key].distMi : defaultMid(week); }
function convertMilesToUnit(mi){ return state.distUnit==='mi'? round1(mi) : round1(mi2km(mi)); }
function convertUnitToMiles(v){ return state.distUnit==='mi'? v : km2mi(v); }
function ensure(key){ if(!state.sessions[key]) state.sessions[key]={done:false, distMi:null}; }

function currentBodyKg(){ const bw=parseFloat(document.getElementById('bodyWeight').value||state.bodyWeight); if(!isFinite(bw)||bw<=0) return null; return ((document.querySelector('input[name="bwUnit"]:checked')?.value)||state.bwUnit)==='kg'?bw:lbs2kg(bw); }

function updateTotals(){
  const weeks = state.weeks || []; const FREQ = state.freq || 3;
  let completed=0, distMi=0, kcal=0, have=false;
  weeks.forEach((w, wi)=>{ for(let i=1;i<=FREQ;i++){ const key=`w${wi+1}d${i}`; const s=state.sessions[key]; if(s?.done){ completed++; const dmi = defaultDistFor(key,w); distMi+=dmi; const kg=currentBodyKg(); if(kg){ const k=(kg + lbs2kg(w.wlbs))*mi2km(dmi)*(parseFloat(document.getElementById('kcalPerKgKm').value||state.kcalPerKgKm)||1.0); kcal+=k; have=true; } } } });
  document.getElementById('doneCount').textContent = `${completed}/${(FREQ*(weeks.length||12))}`;
  const du=state.distUnit; const dOut = du==='mi'? distMi : mi2km(distMi);
  document.getElementById('totalDist').textContent = (Math.round(dOut*10)/10).toFixed(1);
  document.getElementById('totalDistLabel').textContent = `${du} completed`;
  document.getElementById('totalCals').textContent = have? Math.round(kcal) : '—';
}

function updatePlanned(){
  const weeks = state.weeks || []; const FREQ = state.freq || 3; const kg=currentBodyKg();
  const factor=parseFloat(document.getElementById('kcalPerKgKm').value||state.kcalPerKgKm)||1.0;
  let totalMi=0, totalKcal=0; weeks.forEach(w=>{ const per=defaultMid(w); totalMi+=per*FREQ; if(kg){ totalKcal += (kg + lbs2kg(w.wlbs))*mi2km(per)*factor*FREQ; } });
  const distOut = state.distUnit==='mi'? `${round1(totalMi)} mi` : `${round1(mi2km(totalMi))} km`;
  document.getElementById('plannedTotals').textContent = `Planned distance ≈ ${distOut}` + (kg?` · Planned kcal ≈ ${Math.round(totalKcal)}`:'');
}

function wireSettings(){
  const bw=document.getElementById('bodyWeight'); if(state.bodyWeight!=='') bw.value=state.bodyWeight; bw.oninput=()=>{ state.bodyWeight=bw.value; save(); updatePlanned(); updateTotals(); };
  for(const r of document.querySelectorAll('input[name="bwUnit"]')){ r.checked=(r.value===state.bwUnit); r.onchange=()=>{ state.bwUnit=r.value; save(); updatePlanned(); updateTotals(); }; }
  for(const r of document.querySelectorAll('input[name="distUnit"]')){ r.checked=(r.value===state.distUnit); r.onchange=()=>{ state.distUnit=r.value; save(); render(); }; }
  for(const r of document.querySelectorAll('input[name="wtUnit"]')){ r.checked=(r.value===state.wtUnit); r.onchange=()=>{ state.wtUnit=r.value; save(); render(); }; }
  const factor=document.getElementById('kcalPerKgKm'); factor.value=state.kcalPerKgKm; factor.oninput=()=>{ state.kcalPerKgKm=parseFloat(factor.value)||1.0; save(); updatePlanned(); updateTotals(); };
  document.getElementById('resetBtn').onclick=()=>{ if(confirm('Reset all progress?')){ state.sessions={}; save(); render(); } };
}

function saveUpdate(){ save(); updateTotals(); }

// Boot
render();
</script>
</body>
</html>


